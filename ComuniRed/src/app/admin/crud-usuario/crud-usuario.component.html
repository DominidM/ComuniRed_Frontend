<div class="crud-usuario-root">
  <div class="crud-usuario-card">
    <div class="crud-usuario-header">
      <h2>Gestión de Usuarios</h2>
      <button class="btn-primary" (click)="openAddModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Nuevo Usuario
      </button>
    </div>

    <!-- Controles superiores: Buscador + mostrar por página + total -->
    <div class="crud-usuario-controls-row">
      <div class="crud-usuario-search-box">
        <input type="text" [(ngModel)]="searchText" placeholder="Buscar por nombre, apellido, DNI..." />
        <!-- BOTÓN DE BÚSQUEDA CON ICONO LUPA -->
        <button class="crud-usuario-search-btn" (click)="buscarUsuario()" aria-label="Buscar usuario">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <line x1="21" y1="21" x2="16.65" y2="16.65"/>
          </svg>
        </button>
      </div>
      <div class="crud-usuario-show-select">
        <label for="pageSize">por página</label>
        <select id="pageSize" (change)="onPageSizeChange($event)" [value]="size">
          <option *ngFor="let s of pageSizes" [value]="s">{{ s }}</option>
        </select>
        <span>Total: {{ totalElements }}</span>
      </div>
    </div>

    <div *ngIf="usuarios && usuarios.length > 0; else noUsuarios">
      <table class="crud-usuario-table">
        <thead>
          <tr>
            <th style="display: none;">ID</th>
            <th>Nombre</th>
            <th>Apellido</th>
            <th>Rol</th>
            <th>DNI</th>
            <th>Distrito</th>
            <th>Fecha Nacimiento</th>
            <th>Fecha Registro</th> 
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let usuario of usuarios; trackBy: trackByUsuarioId">
            <td style="display: none;">{{ usuario.id }}</td>
            <td><div class="user-name">{{ usuario.nombre }}</div></td>
            <td><div class="user-lastname">{{ usuario.apellido }}</div></td>
            <td><div class="user-role">{{ getRolNombre(usuario.rol_id) }}</div></td>
            <td><div class="user-dni">{{ usuario.dni }}</div></td>
            <td><div class="user-district">{{ usuario.distrito }}</div></td>
            
              <td>{{ usuario.fecha_nacimiento | date:'dd/MM/yyyy' }}</td>
              <td>{{ usuario.fecha_registro | date:'dd/MM/yyyy HH:mm' }}</td>
            
              <td>
              <div class="action-buttons">
                <button class="btn-edit" (click)="openEditModal(usuario)" title="Editar usuario">Editar</button>
                <button class="btn-delete" (click)="deleteUsuario(usuario)" title="Eliminar usuario">Eliminar</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <ng-template #noUsuarios>
      <div class="crud-usuario-empty">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 1rem; color: #000000;">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        <p>No hay usuarios registrados</p>
        <button class="btn-primary" (click)="openAddModal()" style="margin-top: 1rem;">Crear primer usuario</button>
      </div>
    </ng-template>

    <!-- Paginación abajo centrada y contador -->
    <div class="crud-usuario-pagination-row" *ngIf="totalElements > 0">
      <div class="crud-usuario-pagination">
        <button class="crud-usuario-pagination-btn" (click)="prevPage()" [disabled]="page === 0"><b>&lt; Anterior</b></button>
        <span class="crud-usuario-pagination-info"><b>Página {{ page + 1 }} de {{ totalPages }}</b></span>
        <button class="crud-usuario-pagination-btn" (click)="nextPage()" [disabled]="page >= totalPages - 1"><b>Siguiente &gt;</b></button>
      </div>
      <div class="crud-usuario-pagination-count">
        <span>Mostrando {{ usuarios.length }} de {{ totalElements }} datos.</span>
      </div>
    </div>

    <!-- Modal Formulario -->
    <div class="crud-usuario-modal" *ngIf="showModal" (click)="closeModal()">
      <div class="crud-usuario-modal-content" (click)="$event.stopPropagation()">
        <h3>{{ editingUsuario ? 'Editar Usuario' : 'Nuevo Usuario' }}</h3>

        <form (ngSubmit)="saveUsuario(usuarioForm)" #usuarioForm="ngForm">

        <div class="form-group imagen-perfil">
          <label for="foto_perfil" class="form-label">Foto de Perfil</label>

          <div class="imagen-preview">
            <img
              [src]="imagenPreview || usuarioData.foto_perfil || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'"
              alt="Foto de perfil"
              class="preview"
            />
          </div>

          <input
            type="file"
            id="foto_perfil"
            accept="image/*"
            (change)="onFileSelected($event)"
            class="form-control archivo-input"
          />

          <button
            *ngIf="imagenPreview || usuarioData.foto_perfil"
            type="button"
            class="btn-quitar-foto"
            (click)="quitarFoto()"
          >
            Quitar foto
          </button>
        </div>

          <div class="form-row">
            <div class="form-group">
              <label for="nombre">Nombre *</label>
              <input id="nombre" name="nombre" type="text" [(ngModel)]="usuarioData.nombre" required placeholder="Nombre del usuario" autocomplete="off"/>
            </div>
            <div class="form-group">
              <label for="apellido">Apellido *</label>
              <input id="apellido" name="apellido" type="text" [(ngModel)]="usuarioData.apellido" required placeholder="Apellido del usuario" autocomplete="off"/>
            </div>
          </div>

          <!-- DNI / Teléfono -->
          <div class="form-row">
            <div class="form-group">
              <label for="dni">DNI</label>
              <input id="dni" name="dni" type="text" [(ngModel)]="usuarioData.dni" placeholder="12345678" maxlength="8" (input)="onNumericInput($event,'dni',8)"/>
            </div>
            <div class="form-group">
              <label for="numero_telefono">Teléfono</label>
              <input id="numero_telefono" name="numero_telefono" type="text" [(ngModel)]="usuarioData.numero_telefono" placeholder="987654321" maxlength="15" (input)="onTelefonoInput($event)"/>
            </div>
          </div>

          <!-- Edad / Sexo -->
          <div class="form-row">
            <div class="form-group">
              <label for="edad">Edad</label>
              <input id="edad" name="edad" type="number" [(ngModel)]="usuarioData.edad" min="0" max="120"/>
            </div>
            <div class="form-group">
              <label for="sexo">Sexo</label>
              <select id="sexo" name="sexo" [(ngModel)]="usuarioData.sexo">
                <option value="">Seleccionar...</option>
                <option value="M">Masculino</option>
                <option value="F">Femenino</option>
              </select>
            </div>
          </div>

          <!-- Distrito / Código Postal -->
          <div class="form-row">
            <div class="form-group">
              <label for="distrito">Distrito</label>
              <input id="distrito" name="distrito" type="text" [(ngModel)]="usuarioData.distrito" placeholder="Ej: Miraflores" autocomplete="off"/>
            </div>
            <div class="form-group">
              <label for="codigo_postal">Código Postal</label>
              <input id="codigo_postal" name="codigo_postal" type="text" [(ngModel)]="usuarioData.codigo_postal" placeholder="15074" maxlength="10" autocomplete="off"/>
            </div>
          </div>

          <!-- Dirección / Email -->
          <div class="form-group">
            <label for="direccion">Dirección</label>
            <input id="direccion" name="direccion" type="text" [(ngModel)]="usuarioData.direccion"/>
          </div>

          <div class="form-group">
            <label for="email">Email *</label>
            <input id="email" name="email" type="email" [(ngModel)]="usuarioData.email" required/>
          </div>

          <!-- Password / Rol -->
          <div class="form-row">
            <div class="form-group">
              <label for="password">Contraseña {{ !editingUsuario ? '*' : '' }}</label>
              <input id="password" name="password" type="password" [(ngModel)]="usuarioData.password" [required]="!editingUsuario"/>
            </div>
            <div class="form-group">
              <label for="rol_id">Rol *</label>
              <select id="rol_id" name="rol_id" [(ngModel)]="usuarioData.rol_id" required>
                <option value="">Seleccionar rol...</option>
                <option *ngFor="let r of roles" [value]="r.id">{{ r.nombre }}</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="fecha_nacimiento">Fecha de nacimiento</label>
            <input
              id="fecha_nacimiento"
              name="fecha_nacimiento"
              type="date"
              [(ngModel)]="usuarioData.fecha_nacimiento"
            />
          </div>

          <div class="form-group">
            <label for="fecha_registro">Fecha de registro</label>
            <input
              id="fecha_registro"
              name="fecha_registro"
              type="datetime-local"
              [(ngModel)]="usuarioData.fecha_registro"
              readonly
            />
          </div>

          <div class="crud-usuario-modal-actions">
            <button type="button" class="btn-cancel" (click)="closeModal()">Cancelar</button>
            <button type="submit" class="btn-primary" [disabled]="!usuarioForm.form.valid || saving">{{ editingUsuario ? 'Actualizar' : 'Guardar' }}</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>