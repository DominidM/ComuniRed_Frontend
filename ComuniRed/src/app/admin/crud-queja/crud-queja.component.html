<div class="crud-queja-root">
  <div class="crud-queja-header">
    <h2>Gestión de Quejas / Reportes</h2>
    <button class="btn-primary" (click)="openAddModal()">Nueva Queja</button>
  </div>

  <div *ngIf="quejas && quejas.length > 0; else noQuejas">
    <div class="table-wrapper">
      <table class="crud-queja-table">
        <colgroup>
          <col style="width: 40%;">  <!-- descripcion -->
          <col style="width: 15%;">  <!-- fecha -->
          <col style="width: 15%;">  <!-- usuario -->
          <col style="width: 10%;">  <!-- estado -->
          <col style="width: 15%;">  <!-- imagen -->
          <col style="width: 5%;">   <!-- acciones -->
        </colgroup>

        <thead>
          <tr>
            <th>Descripción</th>
            <th>Fecha</th>
            <th>Usuario</th>
            <th>Estado</th>
            <th>Imagen</th>
            <th>Acciones</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let queja of quejas" class="row-item">
            <td class="td-desc">
              <div class="cell-inner">
                <div class="desc-title">{{ queja.titulo || '' }}</div>
                <div class="desc-text">{{ queja.descripcion }}</div>
              </div>
            </td>

            <td class="td-meta">
              <div class="cell-inner">
                <div class="meta">{{ queja.fecha_creacion | date:'short' }}</div>
              </div>
            </td>

            <td class="td-meta">
              <div class="cell-inner">
                <div class="meta">{{ queja.usuario_nombre }}</div>
              </div>
            </td>

            <td class="td-meta">
              <div class="cell-inner">
                <span class="status-badge small">{{ queja.estado_nombre || '—' }}</span>
              </div>
            </td>

            <td class="td-image">
              <div class="cell-inner image-wrap">
                <ng-container *ngIf="queja.imagen_url; else noImage">
                  <a [href]="queja.imagen_url" target="_blank" rel="noreferrer">
                    <img [src]="queja.imagen_url" alt="Imagen" class="thumb" />
                  </a>
                </ng-container>
                <ng-template #noImage>
                  <span class="small-muted">Sin imagen</span>
                </ng-template>
              </div>
            </td>

            <td class="td-actions">
              <div class="cell-inner actions-inline">
                <!-- Cambiado: en vez de "Editar" abrimos modal de asignación -->
                <button class="btn btn-edit" (click)="openAssignModal(queja)">Asignar</button>
                <button class="btn btn-delete" (click)="deleteQueja(queja)">Eliminar</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <ng-template #noQuejas>
    <div class="crud-queja-empty">
      No hay quejas registradas.
    </div>
  </ng-template>

  <!-- Modal: si editingQueja == null -> crear, si editingQueja != null -> asignar -->
  <div class="crud-queja-modal" *ngIf="showModal">
    <div class="crud-queja-modal-content">
      <h3 *ngIf="!editingQueja">{{ 'Nueva Queja' }}</h3>
      <h3 *ngIf="editingQueja">{{ 'Asignar Queja' }}</h3>

      <!-- CREAR / EDIT FORM (cuando creating a new queja) -->
      <form *ngIf="!editingQueja" (ngSubmit)="saveQueja()" #quejaForm="ngForm">
        <div class="form-group">
          <label for="descripcion">Descripción</label>
          <textarea id="descripcion" name="descripcion" [(ngModel)]="quejaData.descripcion" required></textarea>
        </div>
        <div class="form-group">
          <label for="usuario_id">Usuario</label>
          <select id="usuario_id" name="usuario_id" [(ngModel)]="quejaData.usuario_id" required>
            <option *ngFor="let usuario of usuarios" [value]="usuario.id">{{ usuario.nombre }}</option>
          </select>
        </div>
        <div class="form-group">
          <label for="estado_id">Estado</label>
          <select id="estado_id" name="estado_id" [(ngModel)]="quejaData.estado_id" required>
            <option *ngFor="let estado of estados" [value]="estado.id">{{ estado.nombre }}</option>
          </select>
        </div>
        <div class="form-group">
          <label for="imagen_url">Imagen (URL)</label>
          <input id="imagen_url" name="imagen_url" [(ngModel)]="quejaData.imagen_url" type="url" />
        </div>

        <div class="crud-queja-modal-actions">
          <button type="submit" class="btn-primary">Guardar</button>
          <button type="button" class="btn-cancel" (click)="closeModal()">Cancelar</button>
        </div>
      </form>

      <!-- ASSIGN FORM (when editingQueja is set) -->
      <div *ngIf="editingQueja">
        <div class="form-group">
          <label>Queja</label>
          <div class="small-muted">{{ editingQueja.titulo || editingQueja.descripcion }}</div>
        </div>

        <div class="form-group">
          <label for="soporteSelect">Asignar a (Soporte)</label>
          <select id="soporteSelect" class="form-control" [(ngModel)]="selectedSoporteId" name="selectedSoporteId">
            <option value="">-- Selecciona un usuario de soporte --</option>
            <option *ngFor="let u of usuariosSoporte" [value]="u.id">{{ u.nombre }} {{ u.apellido }}</option>
          </select>
        </div>

        <div class="form-group">
          <label for="comentariosAsignacion">Comentarios (opcional)</label>
          <input id="comentariosAsignacion" type="text" [(ngModel)]="comentariosAsignacion" name="comentariosAsignacion" />
        </div>

        <div class="crud-queja-modal-actions">
          <button type="button" class="btn-primary" (click)="onAssignToSupport()" [disabled]="!selectedSoporteId || loading">
            {{ loading ? 'Asignando...' : 'Asignar' }}
          </button>
          <button type="button" class="btn-cancel" (click)="closeModal()">Cancelar</button>
        </div>
      </div>

    </div>
  </div>
</div>