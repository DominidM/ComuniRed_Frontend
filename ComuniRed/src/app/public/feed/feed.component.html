<!-- Feed main container -->
<div class="feed-container">
  
  <!-- Toast Notification -->
  <div *ngIf="showToast" class="toast-notification">
    {{ toastMessage }}
  </div>

  <!-- Loading Overlay -->
  <div *ngIf="loading" class="loading-overlay">
    <div class="spinner"></div>
  </div>

  <!-- Barra de bÃºsqueda y filtros -->
  <div class="filters-bar card">
    <div class="search-container">
      <input 
        type="text" 
        class="search-input"
        [(ngModel)]="searchTerm"
        (ngModelChange)="onSearchChange()"
        placeholder="ğŸ” Buscar reportes..."
      />
    </div>

    <div class="filters-row">
      <select 
        class="filter-select"
        [(ngModel)]="selectedCategory"
        (ngModelChange)="onCategoryFilterChange()"
      >
        <option value="">Todas las categorÃ­as</option>
        <option *ngFor="let cat of categorias" [value]="cat.id">{{ cat.nombre }}</option>
      </select>

      <select 
        class="filter-select"
        [(ngModel)]="sortBy"
        (ngModelChange)="onSortChange()"
      >
        <option value="recent">MÃ¡s recientes</option>
        <option value="popular">MÃ¡s populares</option>
        <option value="votes">MÃ¡s votados</option>
      </select>

      <button 
        *ngIf="searchTerm || selectedCategory || sortBy !== 'recent'" 
        class="btn-clear-filters"
        (click)="clearFilters()"
      >
        âœ• Limpiar
      </button>

      <button class="btn-refresh" (click)="refreshPosts()" title="Actualizar">
        ğŸ”„
      </button>
    </div>
  </div>

  <!-- Create / report card (top) -->
  <div class="create-card card">
    <div class="create-top">
      <div class="create-avatar">
        <img [src]="user?.avatarUrl" [alt]="user?.name" class="user-avatar" />
      </div>
      <button class="create-input" (click)="openCreateReport()" aria-label="Crear reporte">
        Â¿QuÃ© problema de infraestructura quieres reportar?
      </button>
    </div>

    <div class="create-sep"></div>

    <div class="create-actions">
      <button class="create-action" type="button" (click)="openCreateReportWithMedia()">
        <span class="create-icon">ğŸ–¼ï¸</span>
        <span>Foto/Video</span>
      </button>
      <button class="create-action" type="button" (click)="openCreateReportWithLocation()">
        <span class="create-icon">ğŸ“</span>
        <span>UbicaciÃ³n</span>
      </button>
    </div>
  </div>

  <!-- Modal para crear queja -->
  <div *ngIf="showCreateModal" class="modal-overlay" (click)="closeCreateModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">Crear Reporte</h2>
        <button class="modal-close" (click)="closeCreateModal()" aria-label="Cerrar">âœ•</button>
      </div>

      <div class="modal-body">
        <div class="modal-user">
          <img [src]="user?.avatarUrl" [alt]="user?.name" class="modal-avatar" />
          <span class="modal-username">{{ user?.name }}</span>
        </div>

        <form class="create-form">
          <div class="form-group">
            <label for="titulo" class="form-label">TÃ­tulo del problema</label>
            <input 
              type="text" 
              id="titulo" 
              class="form-input"
              [(ngModel)]="newQueja.titulo"
              name="titulo"
              placeholder="Ej: Bache peligroso en la avenida principal"
              maxlength="100"
            />
          </div>

          <div class="form-group">
            <label for="descripcion" class="form-label">DescripciÃ³n detallada</label>
            <textarea 
              id="descripcion" 
              class="form-textarea"
              [(ngModel)]="newQueja.descripcion"
              name="descripcion"
              placeholder="Describe el problema de infraestructura que quieres reportar..."
              rows="4"
            ></textarea>
          </div>

          <div class="form-group">
            <label for="categoria" class="form-label">CategorÃ­a</label>
            <select 
              id="categoria" 
              class="form-select"
              [(ngModel)]="newQueja.categoriaId"
              name="categoria"
            >
              <option value="">Selecciona una categorÃ­a</option>
              <option *ngFor="let cat of categorias" [value]="cat.id">{{ cat.nombre }}</option>
            </select>
          </div>

          <div class="form-group">
            <label for="ubicacion" class="form-label">ğŸ“ UbicaciÃ³n</label>
            <input 
              type="text" 
              id="ubicacion" 
              class="form-input"
              [(ngModel)]="newQueja.ubicacion"
              name="ubicacion"
              placeholder="Ej: Av. Principal 123, San Isidro"
            />
          </div>

          <div class="form-group">
            <label class="form-label">ğŸ–¼ï¸ Foto del problema (opcional, mÃ¡x 5MB)</label>
            <div class="upload-area" (click)="fileInput.click()">
              <input 
                #fileInput
                type="file" 
                accept="image/*" 
                (change)="onFileSelected($event)"
                style="display: none;"
              />
              <div *ngIf="!newQueja.imagenPreview" class="upload-placeholder">
                <span class="upload-icon">ğŸ“·</span>
                <span class="upload-text">Click para subir una foto</span>
              </div>
              <div *ngIf="newQueja.imagenPreview" class="image-preview">
                <img [src]="newQueja.imagenPreview" alt="Preview" />
                <button 
                  type="button" 
                  class="remove-image" 
                  (click)="removeImage($event)"
                >
                  âœ•
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button 
          type="button" 
          class="btn btn-cancel" 
          (click)="closeCreateModal()"
        >
          Cancelar
        </button>
        <button 
          type="button" 
          class="btn btn-primary" 
          (click)="submitQueja()"
          [disabled]="!isFormValid() || loading"
        >
          {{ loading ? 'Publicando...' : 'Publicar Reporte' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Modal para editar queja -->
  <div *ngIf="showEditModal && editingQueja" class="modal-overlay" (click)="closeEditModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">Editar Reporte</h2>
        <button class="modal-close" (click)="closeEditModal()" aria-label="Cerrar">âœ•</button>
      </div>

      <div class="modal-body">
        <form class="create-form">
          <div class="form-group">
            <label for="edit-titulo" class="form-label">TÃ­tulo</label>
            <input 
              type="text" 
              id="edit-titulo" 
              class="form-input"
              [(ngModel)]="editingQueja.titulo"
              name="titulo"
              maxlength="100"
            />
          </div>

          <div class="form-group">
            <label for="edit-descripcion" class="form-label">DescripciÃ³n</label>
            <textarea 
              id="edit-descripcion" 
              class="form-textarea"
              [(ngModel)]="editingQueja.descripcion"
              name="descripcion"
              rows="4"
            ></textarea>
          </div>

          <div class="form-group">
            <label for="edit-ubicacion" class="form-label">ğŸ“ UbicaciÃ³n</label>
            <input 
              type="text" 
              id="edit-ubicacion" 
              class="form-input"
              [(ngModel)]="editingQueja.ubicacion"
              name="ubicacion"
            />
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-cancel" (click)="closeEditModal()">Cancelar</button>
        <button class="btn btn-primary" (click)="saveEditQueja()" [disabled]="loading">
          {{ loading ? 'Guardando...' : 'Guardar Cambios' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Posts -->
  <ng-container *ngIf="displayedPosts.length > 0; else emptyState">
    <div *ngFor="let post of displayedPosts; trackBy: trackByPostId" class="post-card">
      
      <div class="post-header">
        <!-- âœ… FOTO CLICKEABLE -->
        <div class="avatar-container" (click)="verPerfilUsuario(post.usuario)">
          <img [src]="getAvatarUrl(post)" [alt]="getAuthorName(post)" class="avatar clickable" />
        </div>

        <div class="post-info">
          <div class="post-title-row">
            <div>
              <!-- âœ… NOMBRE CLICKEABLE -->
              <div class="post-author clickable" (click)="verPerfilUsuario(post.usuario)">
                {{ getAuthorName(post) }}
              </div>
              <div class="post-meta">
                <span class="post-date">{{ getPostDate(post) }}</span>
                <ng-container *ngIf="hasLocation(post)">
                  <span class="dot-sep">â€¢</span>
                  <span class="post-location">ğŸ“ {{ getLocation(post) }}</span>
                </ng-container>
              </div>
            </div>

            <!-- MenÃº de opciones -->
            <div class="post-menu-container">
              <button class="post-menu" aria-label="MÃ¡s opciones" (click)="post.showMenu = !post.showMenu">â‹¯</button>
              
              <div *ngIf="post.showMenu" class="post-menu-dropdown">
                <button 
                  *ngIf="canEditQueja(post)" 
                  class="menu-item"
                  (click)="openEditQueja(post); post.showMenu = false"
                >
                  âœï¸ Editar
                </button>
                <button 
                  *ngIf="canEditQueja(post)" 
                  class="menu-item danger"
                  (click)="deleteQueja(post); post.showMenu = false"
                >
                  ğŸ—‘ï¸ Eliminar
                </button>
                <button class="menu-item" (click)="sharePost(post); post.showMenu = false">
                  ğŸ“¤ Compartir
                </button>
                <button class="menu-item" (click)="toggleBookmark(post); post.showMenu = false">
                  {{ getBookmarkEmoji(post) }} {{ getBookmarkText(post) }}
                </button>
              </div>
            </div>
          </div>

          <h3 class="post-heading">{{ getTitle(post) }}</h3>
          <p class="post-text">{{ getDescription(post) }}</p>

          <div class="post-tags">
            <span class="tag category-tag">{{ getCategoryName(post) }}</span>
            <span *ngIf="post.estado?.nombre" class="tag status-tag">{{ post.estado?.nombre }}</span>
          </div>

          <div *ngIf="hasLocation(post)" class="post-location-line">
            <span class="location-icon">ğŸ“</span>
            <span class="location-text">{{ getLocation(post) }}</span>
          </div>
        </div>
      </div>

      <div class="post-image-wrapper">
        <ng-container *ngIf="hasEvidence(post) || post.imagen_url; else imagePlaceholder">
          <img [src]="getFirstEvidenceUrl(post)" [alt]="getTitle(post)" class="post-image" />
        </ng-container>
        
        <ng-template #imagePlaceholder>
          <div class="image-placeholder">
            <div class="image-placeholder-icon">ğŸ–¼ï¸</div>
          </div>
        </ng-template>
      </div>

      <!-- Vote section -->
      <div *ngIf="hasVotes(post)" class="vote-section">
        <div class="vote-question">
          Â¿EstÃ¡s de acuerdo con este reporte?
          <span class="vote-count">{{ getTotalVotes(post) }} votos</span>
        </div>

        <div class="vote-buttons">
          <button
            class="vote-btn accept"
            [class.voted]="post.userVote === 'YES'"
            [disabled]="!canVote(post)"
            (click)="vote(post, 'accept')"
          >
            âœ… SÃ­ ({{ getYesVotes(post) }})
          </button>

          <button
            class="vote-btn reject"
            [class.voted]="post.userVote === 'NO'"
            [disabled]="!canVote(post)"
            (click)="vote(post, 'reject')"
          >
            âŒ No ({{ getNoVotes(post) }})
          </button>
        </div>
      </div>

      <!-- Reactions bar -->
      <div class="reactions-bar">
        <button 
          class="reaction-btn" 
          [class.active]="post.reactions.userReaction === 'like'"
          (click)="toggleReaction(post, 'like')"
          title="Me gusta"
        >
          {{ post.reactions.userReaction === 'like' ? 'â¤ï¸' : 'ğŸ¤' }}
          <span class="count">{{ getReactionCount(post, 'like') }}</span>
        </button>

        <button 
          class="reaction-btn" 
          [class.active]="post.reactions.userReaction === 'love'"
          (click)="toggleReaction(post, 'love')"
          title="Love"
        >
          {{ post.reactions.userReaction === 'love' ? 'ğŸ’–' : 'ğŸ©¶' }}
          <span class="count">{{ getReactionCount(post, 'love') }}</span>
        </button>

        <button 
          class="reaction-btn" 
          [class.active]="post.reactions.userReaction === 'wow'"
          (click)="toggleReaction(post, 'wow')"
          title="Wow"
        >
          {{ post.reactions.userReaction === 'wow' ? 'ğŸ˜®' : 'ğŸ˜' }}
          <span class="count">{{ getReactionCount(post, 'wow') }}</span>
        </button>

        <button 
          class="reaction-btn" 
          [class.active]="post.reactions.userReaction === 'helpful'"
          (click)="toggleReaction(post, 'helpful')"
          title="Ãštil"
        >
          {{ post.reactions.userReaction === 'helpful' ? 'ğŸ‘' : 'ğŸ‘' }}
          <span class="count">{{ getReactionCount(post, 'helpful') }}</span>
        </button>
      </div>

      <!-- Actions row -->
      <div class="post-actions">
        <div class="left-actions">
          <button class="action-btn" (click)="toggleComments(post)">
            <span class="action-emoji">ğŸ’¬</span>
            <span class="action-text">{{ post.commentsCount || (post.comments.length || 0) }}</span>          
          </button>
        </div>

        <div class="right-actions">
          <button class="action-btn" (click)="toggleBookmark(post)">
            <span class="action-emoji">{{ getBookmarkEmoji(post) }}</span>
            <span class="action-text">Guardar</span>
          </button>

          <button class="action-btn" (click)="sharePost(post)">
            <span class="action-emoji">ğŸ“¤</span>
            <span class="action-text">Compartir</span>
          </button>

          <button class="action-btn" (click)="downloadPostJson(post)">
            <span class="action-emoji">â¬‡ï¸</span>
            <span class="action-text">JSON</span>
          </button>
        </div>
      </div>

      <!-- Comments -->
      <div *ngIf="getShowComments(post)" class="comments-section">
        <div *ngFor="let comment of post.comments || []; trackBy: trackByComment" class="comment-wrapper">
          <div *ngIf="editingCommentId !== comment.id" class="comment">
            <!-- âœ… FOTO + NOMBRE CLICKEABLE -->
            <div class="comment-header">
              <img 
                [src]="comment.author.foto_perfil || 'assets/img/default-avatar.png'" 
                [alt]="getCommentAuthor(comment)"
                class="comment-avatar clickable"
                (click)="verPerfilUsuario(comment.author)"
              />
              <strong 
                class="comment-author clickable" 
                (click)="verPerfilUsuario(comment.author)"
              >
                {{ getCommentAuthor(comment) }}
              </strong>
            </div>
            
            <div class="comment-text">
              {{ getCommentText(comment) }}
            </div>
            
            <div *ngIf="canEditComment(comment)" class="comment-actions">
              <button class="comment-action-btn" (click)="startEditComment(comment)">âœï¸</button>
              <button class="comment-action-btn danger" (click)="deleteComment(post, comment.id)">ğŸ—‘ï¸</button>
            </div>
          </div>

          <div *ngIf="editingCommentId === comment.id" class="comment-edit">
            <input 
              type="text" 
              class="comment-edit-input"
              [(ngModel)]="editingCommentText"
              (keyup.enter)="saveEditComment(post)"
              (keyup.escape)="cancelEditComment()"
            />
            <div class="comment-edit-actions">
              <button class="btn-comment-save" (click)="saveEditComment(post)">âœ“</button>
              <button class="btn-comment-cancel" (click)="cancelEditComment()">âœ•</button>
            </div>
          </div>
        </div>

        <div class="comment-input-container">
          <input
            #commentInput
            type="text"
            class="comment-input"
            placeholder="Escribe un comentario..."
            (keyup.enter)="addComment(post, commentInput.value); commentInput.value = ''"
          />
          <button 
            class="btn-send-comment"
            (click)="addComment(post, commentInput.value); commentInput.value = ''"
          >
            â¤
          </button>
        </div>
      </div>
    </div>
  </ng-container>

  <!-- Empty state -->
  <ng-template #emptyState>
    <div class="no-posts">
      <div class="no-posts-inner">
        <div class="no-posts-icon">ğŸ”</div>
        <h3>No se encontraron reportes</h3>
        <p *ngIf="searchTerm || selectedCategory">Intenta cambiar los filtros o tÃ©rminos de bÃºsqueda</p>
        <p *ngIf="!searchTerm && !selectedCategory">SÃ© el primero en reportar un problema</p>
        <button *ngIf="searchTerm || selectedCategory" class="btn-primary" (click)="clearFilters()">
          Limpiar filtros
        </button>
      </div>
    </div>
  </ng-template>
</div>
