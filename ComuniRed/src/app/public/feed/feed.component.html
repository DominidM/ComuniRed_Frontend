<div class="feed-container">
  
  <!-- Toast Notification -->
  <div *ngIf="showToast" class="toast-notification">
    {{ toastMessage }}
  </div>

  <!-- Loading Overlay -->
  <div *ngIf="loading" class="loading-overlay">
    <div class="spinner"></div>
  </div>

  <!-- Crear Reporte -->
  <div class="create-card card">
    <div class="create-top">
      <div class="create-avatar">
        <img [src]="user?.avatarUrl" [alt]="user?.name" class="user-avatar" />
      </div>
      <button class="create-input" (click)="openCreateReport()" aria-label="Crear reporte">
        ¬øQu√© problema de infraestructura quieres reportar?
      </button>
    </div>

    <div class="create-sep"></div>

    <div class="create-actions">
      <button class="create-action" type="button" (click)="openCreateReportWithMedia()">
        <i class="bi bi-image create-icon"></i>
        <span>Foto/Video</span>
      </button>
      <button class="create-action" type="button" (click)="openCreateReportWithLocation()">
        <i class="bi bi-geo-alt-fill create-icon"></i>
        <span>Ubicaci√≥n</span>
      </button>
    </div>
  </div>

  <!-- Modal Crear Reporte -->
  <div *ngIf="showCreateModal" class="modal-overlay" (click)="closeCreateModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">Crear Reporte</h2>
        <button class="modal-close" (click)="closeCreateModal()" aria-label="Cerrar">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="modal-user">
          <img [src]="user?.avatarUrl" [alt]="user?.name" class="modal-avatar" />
          <span class="modal-username">{{ user?.name }}</span>
        </div>

        <form class="create-form">
          <div class="form-group">
            <label for="titulo" class="form-label">T√≠tulo del problema</label>
            <input 
              type="text" 
              id="titulo" 
              class="form-input"
              [(ngModel)]="newQueja.titulo"
              name="titulo"
              placeholder="Ej: Bache peligroso en la avenida principal"
              maxlength="100"
            />
          </div>

          <div class="form-group">
            <label for="descripcion" class="form-label">Descripci√≥n detallada</label>
            <textarea 
              id="descripcion" 
              class="form-textarea"
              [(ngModel)]="newQueja.descripcion"
              name="descripcion"
              placeholder="Describe el problema de infraestructura que quieres reportar..."
              rows="4"
            ></textarea>
          </div>

          <div class="form-group">
            <label for="categoria" class="form-label">Categor√≠a</label>
            <select 
              id="categoria" 
              class="form-select"
              [(ngModel)]="newQueja.categoriaId"
              name="categoria"
            >
              <option value="">Selecciona una categor√≠a</option>
              <option *ngFor="let cat of categorias" [value]="cat.id">{{ cat.nombre }}</option>
            </select>
          </div>

          <div class="form-group">
            <label for="ubicacion" class="form-label">üìç Ubicaci√≥n</label>
            <input 
              type="text" 
              id="ubicacion" 
              class="form-input"
              [(ngModel)]="newQueja.ubicacion"
              name="ubicacion"
              placeholder="Ej: Av. Principal 123, San Isidro"
            />
          </div>

          <div class="form-group">
            <label class="form-label">üñºÔ∏è Foto del problema (opcional, m√°x 5MB)</label>
            <div class="upload-area" (click)="fileInput.click()">
              <input 
                #fileInput
                type="file" 
                accept="image/*" 
                (change)="onFileSelected($event)"
                style="display: none;"
              />
              <div *ngIf="!newQueja.imagenPreview" class="upload-placeholder">
                <span class="upload-icon">üì∑</span>
                <span class="upload-text">Click para subir una foto</span>
              </div>
              <div *ngIf="newQueja.imagenPreview" class="image-preview">
                <img [src]="newQueja.imagenPreview" alt="Preview" />
                <button 
                  type="button" 
                  class="remove-image" 
                  (click)="removeImage($event)"
                >
                  ‚úï
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button 
          type="button" 
          class="btn btn-cancel" 
          (click)="closeCreateModal()"
        >
          Cancelar
        </button>
        <button 
          type="button" 
          class="btn btn-primary" 
          (click)="submitQueja()"
          [disabled]="!isFormValid() || loading"
        >
          {{ loading ? 'Publicando...' : 'Publicar Reporte' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Editar Reporte -->
  <div *ngIf="showEditModal && editingQueja" class="modal-overlay" (click)="closeEditModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title">Editar Reporte</h2>
        <button class="modal-close" (click)="closeEditModal()" aria-label="Cerrar">‚úï</button>
      </div>

      <div class="modal-body">
        <form class="create-form">
          <div class="form-group">
            <label for="edit-titulo" class="form-label">T√≠tulo</label>
            <input 
              type="text" 
              id="edit-titulo" 
              class="form-input"
              [(ngModel)]="editingQueja.titulo"
              name="titulo"
              maxlength="100"
            />
          </div>

          <div class="form-group">
            <label for="edit-descripcion" class="form-label">Descripci√≥n</label>
            <textarea 
              id="edit-descripcion" 
              class="form-textarea"
              [(ngModel)]="editingQueja.descripcion"
              name="descripcion"
              rows="4"
            ></textarea>
          </div>

          <div class="form-group">
            <label for="edit-ubicacion" class="form-label">üìç Ubicaci√≥n</label>
            <input 
              type="text" 
              id="edit-ubicacion" 
              class="form-input"
              [(ngModel)]="editingQueja.ubicacion"
              name="ubicacion"
            />
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-cancel" (click)="closeEditModal()">Cancelar</button>
        <button class="btn btn-primary" (click)="saveEditQueja()" [disabled]="loading">
          {{ loading ? 'Guardando...' : 'Guardar Cambios' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Posts -->
  <ng-container *ngIf="displayedPosts.length > 0; else emptyState">
    <div *ngFor="let post of getPaginatedPosts(); trackBy: trackByPostId" class="post-card">
      
      <!-- Header del Post -->
      <div class="post-header">
        <div class="avatar-container" (click)="verPerfilUsuario(post.usuario)">
          <img [src]="getAvatarUrl(post)" [alt]="getAuthorName(post)" class="avatar clickable" />
        </div>

        <div class="post-info">
          <div class="post-title-row">
            <div>
              <div class="post-author clickable" (click)="verPerfilUsuario(post.usuario)">
                {{ getAuthorName(post) }}
              </div>
              <div class="post-meta">
                <span class="post-date">{{ getPostDate(post) }}</span>
                <ng-container *ngIf="hasLocation(post)">
                  <span class="dot-sep">‚Ä¢</span>
                  <span class="post-location">üìç {{ getLocation(post) }}</span>
                </ng-container>
              </div>
            </div>

            <!-- Men√∫ de 3 puntos -->
            <div class="post-menu-container">
              <button class="post-menu" aria-label="M√°s opciones" (click)="post.showMenu = !post.showMenu">‚ãØ</button>
              
              <div *ngIf="post.showMenu" class="post-menu-dropdown">
                <button 
                  *ngIf="canEditQueja(post)" 
                  class="menu-item"
                  (click)="openEditQueja(post); post.showMenu = false"
                >
                  ‚úèÔ∏è Editar
                </button>
                <button 
                  *ngIf="canEditQueja(post)" 
                  class="menu-item danger"
                  (click)="deleteQueja(post); post.showMenu = false"
                >
                  üóëÔ∏è Eliminar
                </button>
                <button class="menu-item" (click)="sharePost(post); post.showMenu = false">
                  üì§ Compartir
                </button>
                <button class="menu-item" (click)="toggleBookmark(post); post.showMenu = false">
                  {{ getBookmarkEmoji(post) }} {{ getBookmarkText(post) }}
                </button>
              </div>
            </div>
          </div>

          <h3 class="post-heading">{{ getTitle(post) }}</h3>
          <p class="post-text">{{ getDescription(post) }}</p>

          <div class="post-tags">
            <span class="tag category-tag">{{ getCategoryName(post) }}</span>
            <span *ngIf="post.estado?.nombre" class="tag status-tag">{{ post.estado?.nombre }}</span>
          </div>
        </div>
      </div>

      <!-- Imagen -->
      <div class="post-image-wrapper">
        <ng-container *ngIf="hasEvidence(post) || post.imagen_url; else imagePlaceholder">
          <img [src]="getFirstEvidenceUrl(post)" [alt]="getTitle(post)" class="post-image" />
        </ng-container>
        
        <ng-template #imagePlaceholder>
          <div class="image-placeholder">
            <div class="image-placeholder-icon">üñºÔ∏è</div>
          </div>
        </ng-template>
      </div>

      <!-- Votos -->
      <div *ngIf="hasVotes(post)" class="vote-section">
        <div class="vote-question">
          ¬øEst√°s de acuerdo con este reporte?
          <span class="vote-count">{{ getTotalVotes(post) }} votos</span>
        </div>

        <div class="vote-buttons">
          <button
            class="vote-btn accept"
            [class.voted]="post.userVote === 'YES'"
            [disabled]="!canVote(post)"
            (click)="vote(post, 'accept')"
          >
            ‚úÖ S√≠ ({{ getYesVotes(post) }})
          </button>

          <button
            class="vote-btn reject"
            [class.voted]="post.userVote === 'NO'"
            [disabled]="!canVote(post)"
            (click)="vote(post, 'reject')"
          >
            ‚ùå No ({{ getNoVotes(post) }})
          </button>
        </div>
      </div>

      <!-- Reacciones con men√∫ estilo Facebook -->
      <div class="reactions-bar">
        <div class="reaction-picker-container">
          <button 
            class="reaction-btn main-reaction" 
            [class.active]="post.reactions.userReaction"
            (click)="toggleReactionMenu(post.id, $event)"
            title="Reaccionar"
          >
            <i [class]="post.reactions.userReaction === 'like' ? 'bi bi-heart-fill' : 'bi bi-heart'"></i>
            <span class="count">{{ post.reactions.total || 0 }}</span>
          </button>

          <!-- Men√∫ de reacciones -->
          <div *ngIf="showReactionMenu[post.id]" class="reactions-menu" (click)="$event.stopPropagation()">
            <button class="reaction-option reaction-like" 
                    (click)="selectReaction(post, 'like', $event)"
                    [class.selected]="post.reactions.userReaction === 'like'">
              <span class="emoji">‚ù§Ô∏è</span>
              <span class="label">Me gusta</span>
              <span class="count-small">{{ getReactionCount(post, 'like') }}</span>
            </button>
            
            <button class="reaction-option reaction-love" 
                    (click)="selectReaction(post, 'love', $event)"
                    [class.selected]="post.reactions.userReaction === 'love'">
              <span class="emoji">üòç</span>
              <span class="label">Me encanta</span>
              <span class="count-small">{{ getReactionCount(post, 'love') }}</span>
            </button>
            
            <button class="reaction-option reaction-wow" 
                    (click)="selectReaction(post, 'wow', $event)"
                    [class.selected]="post.reactions.userReaction === 'wow'">
              <span class="emoji">üòÆ</span>
              <span class="label">Me asombra</span>
              <span class="count-small">{{ getReactionCount(post, 'wow') }}</span>
            </button>
            
            <button class="reaction-option reaction-helpful" 
                    (click)="selectReaction(post, 'helpful', $event)"
                    [class.selected]="post.reactions.userReaction === 'helpful'">
              <span class="emoji">üëç</span>
              <span class="label">√ötil</span>
              <span class="count-small">{{ getReactionCount(post, 'helpful') }}</span>
            </button>
            
            <button class="reaction-option reaction-dislike" 
                    (click)="selectReaction(post, 'dislike', $event)"
                    [class.selected]="post.reactions.userReaction === 'dislike'">
              <span class="emoji">üëé</span>
              <span class="label">No me gusta</span>
              <span class="count-small">{{ getReactionCount(post, 'dislike') }}</span>
            </button>
          </div>
        </div>

        <button class="reaction-btn" (click)="toggleComments(post)">
          <i class="bi bi-chat-left-text"></i>
          <span class="count">{{ getCommentsCount(post) }}</span>
        </button>
      </div>

      <!-- Acciones adicionales -->
      <div class="post-actions">
        <div class="left-actions">
          <button class="action-btn" (click)="toggleComments(post)">
            <span class="action-emoji">üí¨</span>
            <span class="action-text">Comentar</span>
          </button>
        </div>

        <div class="right-actions">
          <button class="action-btn" (click)="toggleBookmark(post)">
            <span class="action-emoji">{{ getBookmarkEmoji(post) }}</span>
            <span class="action-text">Guardar</span>
          </button>

          <button class="action-btn" (click)="sharePost(post)">
            <span class="action-emoji">üì§</span>
            <span class="action-text">Compartir</span>
          </button>
        </div>
      </div>

      <!-- Secci√≥n de comentarios (solo 3 preview) -->
      <div *ngIf="getShowComments(post)" class="comments-section">
        <div class="comments-list-preview">
          <div *ngFor="let comment of getPreviewComments(post); trackBy: trackByComment" 
               class="comment-item-preview">
            
            <img [src]="comment.author.foto_perfil || 'assets/img/default-avatar.png'" 
                 [alt]="getCommentAuthor(comment)" 
                 class="comment-avatar-preview clickable"
                 (click)="verPerfilUsuario(comment.author)" />
            
            <div class="comment-content-preview">
              <div class="comment-header-preview">
                <strong class="comment-author-preview clickable" 
                        (click)="verPerfilUsuario(comment.author)">
                  {{ getCommentAuthor(comment) }}
                </strong>
                <span class="comment-date-preview">{{ formatCommentDate(comment.fecha_creacion) }}</span>
                <span *ngIf="comment.fecha_modificacion" class="edited-badge-tiny">
                  <i class="bi bi-pencil-fill"></i>
                </span>
              </div>
              <p class="comment-text-preview">{{ comment.texto }}</p>
            </div>

            <!-- Men√∫ de 3 puntos -->
            <div class="comment-menu-container" *ngIf="canEditComment(comment)">
              <button class="comment-menu-btn" 
                      (click)="$event.stopPropagation(); showCommentMenuModal[comment.id] = !showCommentMenuModal[comment.id]">
                <i class="bi bi-three-dots"></i>
              </button>
              <div *ngIf="showCommentMenuModal[comment.id]" 
                   class="comment-menu-dropdown" 
                   (click)="$event.stopPropagation()">
                <button class="comment-menu-item" 
                        (click)="openCommentsModal(post); startEditComment(comment); showCommentMenuModal[comment.id] = false">
                  <i class="bi bi-pencil"></i> Editar
                </button>
                <button class="comment-menu-item danger" 
                        (click)="deleteComment(post, comment.id); showCommentMenuModal[comment.id] = false">
                  <i class="bi bi-trash"></i> Eliminar
                </button>
              </div>
            </div>
          </div>

          <!-- Bot√≥n ver todos -->
          <button *ngIf="hasMoreComments(post)" 
                  class="view-all-modal-btn" 
                  (click)="openCommentsModal(post)">
            Ver todos los comentarios ({{ getCommentsCount(post) }})
          </button>
        </div>

        <!-- Input para agregar comentario -->
        <div class="comment-input-container">
          <img [src]="user?.avatarUrl || 'assets/img/default-avatar.png'" class="comment-avatar-preview" />
          <input 
            type="text" 
            [(ngModel)]="commentTexts[post.id]"
            placeholder="Escribe un comentario..."
            class="comment-input-preview"
            (keyup.enter)="addComment(post, commentTexts[post.id] || '')"
          />
          <button 
            class="btn-send-preview"
            (click)="addComment(post, commentTexts[post.id] || '')"
            [disabled]="!(commentTexts[post.id] || '').trim()"
          >
            <i class="bi bi-send-fill"></i>
          </button>
        </div>
      </div>

    </div>
  </ng-container>

  <!-- Estado vac√≠o -->
  <ng-template #emptyState>
    <div class="no-posts">
      <div class="no-posts-inner">
        <div class="no-posts-icon">üîç</div>
        <h3>No se encontraron reportes</h3>
        <p *ngIf="searchTerm || selectedCategory">Intenta cambiar los filtros o t√©rminos de b√∫squeda</p>
        <p *ngIf="!searchTerm && !selectedCategory">S√© el primero en reportar un problema</p>
        <button *ngIf="searchTerm || selectedCategory" class="btn-primary" (click)="clearFilters()">
          Limpiar filtros
        </button>
      </div>
    </div>
  </ng-template>

  <!-- MODAL DE COMENTARIOS -->
  <div *ngIf="showCommentsModal" class="modal-overlay" (click)="closeCommentsModal()">
    <div class="modal-comments" (click)="$event.stopPropagation()">
      <div class="modal-header-comments">
        <h3><i class="bi bi-chat-left-text"></i> Conversaciones</h3>
        <button class="modal-close-btn" (click)="closeCommentsModal()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <div class="modal-body-comments">
        <div *ngIf="selectedReporteForComments">
          <div class="report-summary">
            <strong>{{ selectedReporteForComments.titulo }}</strong>
            <span class="comments-count-modal">
              {{ getCommentsCount(selectedReporteForComments) }} 
              {{ getCommentsCount(selectedReporteForComments) === 1 ? 'comentario' : 'comentarios' }}
            </span>
          </div>

          <div class="comments-list-modal">
            <div *ngFor="let comment of selectedReporteForComments.comments || []; trackBy: trackByComment" 
                 class="comment-item-modal">
              
              <div *ngIf="editingCommentId !== comment.id" class="comment-display-modal">
                <img [src]="comment.author.foto_perfil || 'assets/img/default-avatar.png'" 
                     [alt]="getCommentAuthor(comment)" 
                     class="comment-avatar-modal clickable"
                     (click)="verPerfilUsuario(comment.author)" />
                
                <div class="comment-content-modal">
                  <div class="comment-header-modal">
                    <div class="comment-header-left">
                      <strong class="comment-author-modal clickable" 
                              (click)="verPerfilUsuario(comment.author)">
                        {{ getCommentAuthor(comment) }}
                      </strong>
                      <span class="comment-date-modal">{{ formatCommentDate(comment.fecha_creacion) }}</span>
                      <span *ngIf="comment.fecha_modificacion" class="edited-badge-small">
                        <i class="bi bi-pencil-fill"></i>
                      </span>
                    </div>

                    <!-- Men√∫ de 3 puntos en modal -->
                    <div class="comment-menu-modal-container" *ngIf="canEditComment(comment)">
                      <button class="comment-menu-modal-btn" 
                              (click)="$event.stopPropagation(); showCommentMenuModal[comment.id] = !showCommentMenuModal[comment.id]">
                        <i class="bi bi-three-dots"></i>
                      </button>
                      <div *ngIf="showCommentMenuModal[comment.id]" 
                           class="comment-menu-modal-dropdown" 
                           (click)="$event.stopPropagation()">
                        <button class="comment-menu-modal-item" 
                                (click)="startEditComment(comment); showCommentMenuModal[comment.id] = false">
                          <i class="bi bi-pencil"></i> Editar
                        </button>
                        <button class="comment-menu-modal-item danger" 
                                (click)="deleteCommentModal(comment); showCommentMenuModal[comment.id] = false">
                          <i class="bi bi-trash"></i> Eliminar
                        </button>
                      </div>
                    </div>
                  </div>
                  
                  <p class="comment-text-modal">{{ comment.texto }}</p>
                </div>
              </div>

              <div *ngIf="editingCommentId === comment.id" class="comment-edit-modal-full">
                <img [src]="comment.author.foto_perfil || 'assets/img/default-avatar.png'" 
                     class="comment-avatar-modal" />
                <div class="comment-edit-wrapper-modal">
                  <input type="text" 
                         class="comment-edit-input-modal"
                         [(ngModel)]="editingCommentText"
                         (keyup.enter)="saveEditCommentModal()"
                         (keyup.escape)="cancelEditComment()" />
                  <div class="comment-edit-actions-modal">
                    <button class="btn-save-modal" (click)="saveEditCommentModal()">
                      <i class="bi bi-check-lg"></i>
                    </button>
                    <button class="btn-cancel-modal" (click)="cancelEditComment()">
                      <i class="bi bi-x-lg"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div *ngIf="!selectedReporteForComments.comments || selectedReporteForComments.comments.length === 0" 
                 class="no-comments">
              <i class="bi bi-chat-left"></i>
              <p>S√© el primero en comentar</p>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer-comments">
        <img [src]="user?.avatarUrl || 'assets/img/default-avatar.png'" class="comment-avatar-modal" />
        <input type="text" 
               [(ngModel)]="newCommentText" 
               placeholder="Escribe un comentario..." 
               class="comment-input-modal"
               (keyup.enter)="addCommentModal()" />
        <button class="btn-send-modal" (click)="addCommentModal()" [disabled]="!newCommentText.trim()">
          <i class="bi bi-send-fill"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Paginaci√≥n -->
  <div *ngIf="getTotalPages() > 1" class="pagination-container">
    <button class="pagination-btn" 
            [disabled]="currentPage === 1" 
            (click)="prevPage()">
      <i class="bi bi-chevron-left"></i>
      Anterior
    </button>

    <div class="pagination-numbers">
      <button *ngFor="let page of getPageNumbers()" 
              class="pagination-number" 
              [class.active]="page === currentPage"
              [class.ellipsis]="page === -1"
              [disabled]="page === -1"
              (click)="page !== -1 && goToPage(page)">
        {{ page === -1 ? '...' : page }}
      </button>
    </div>

    <button class="pagination-btn" 
            [disabled]="currentPage === getTotalPages()" 
            (click)="nextPage()">
      Siguiente
      <i class="bi bi-chevron-right"></i>
    </button>
  </div>

  <div *ngIf="getTotalPages() > 1" class="pagination-info">
    Mostrando {{ (currentPage - 1) * reportsPerPage + 1 }} - 
    {{ Math.min(currentPage * reportsPerPage, totalReports) }} 
    de {{ totalReports }} reportes
  </div>

</div>
