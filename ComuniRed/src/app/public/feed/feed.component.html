<!-- Feed main container -->
<div class="feed-container">
  <!-- Create / report card (top) -->
  <div class="create-card card">
    <div class="create-top">
      <div class="create-avatar">
        <img [src]="user?.avatarUrl" [alt]="user?.name" class="user-avatar" />
      </div>
      <button class="create-input" (click)="openCreateReport()" aria-label="Crear reporte">
        Â¿QuÃ© problema de infraestructura quieres reportar?
      </button>
    </div>

    <div class="create-sep"></div>

    <div class="create-actions">
      <button class="create-action" type="button" (click)="openCreateReportWithMedia()">
        <span class="create-icon">ğŸ–¼ï¸</span>
        <span>Foto/Video</span>
      </button>
      <button class="create-action" type="button" (click)="openCreateReportWithLocation()">
        <span class="create-icon">ğŸ“</span>
        <span>UbicaciÃ³n</span>
      </button>
    </div>
  </div>

  <!-- Modal para crear queja -->
  <div *ngIf="showCreateModal" class="modal-overlay" (click)="closeCreateModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <!-- Header del modal -->
      <div class="modal-header">
        <h2 class="modal-title">Crear Reporte</h2>
        <button class="modal-close" (click)="closeCreateModal()" aria-label="Cerrar">âœ•</button>
      </div>

      <!-- Contenido del modal -->
      <div class="modal-body">
        <!-- Usuario -->
        <div class="modal-user">
          <img [src]="user?.avatarUrl" [alt]="user?.name" class="modal-avatar" />
          <span class="modal-username">{{ user?.name }}</span>
        </div>

        <!-- Formulario -->
        <form class="create-form">
          <!-- TÃ­tulo -->
          <div class="form-group">
            <label for="titulo" class="form-label">TÃ­tulo del problema</label>
            <input 
              type="text" 
              id="titulo" 
              class="form-input"
              [(ngModel)]="newQueja.titulo"
              name="titulo"
              placeholder="Ej: Bache peligroso en la avenida principal"
              maxlength="100"
            />
          </div>

          <!-- DescripciÃ³n -->
          <div class="form-group">
            <label for="descripcion" class="form-label">DescripciÃ³n detallada</label>
            <textarea 
              id="descripcion" 
              class="form-textarea"
              [(ngModel)]="newQueja.descripcion"
              name="descripcion"
              placeholder="Describe el problema de infraestructura que quieres reportar..."
              rows="4"
            ></textarea>
          </div>

          <!-- CategorÃ­a -->
          <div class="form-group">
            <label for="categoria" class="form-label">CategorÃ­a</label>
            <select 
              id="categoria" 
              class="form-select"
              [(ngModel)]="newQueja.categoria"
              name="categoria"
            >
              <option value="">Selecciona una categorÃ­a</option>
              <option value="vias">ğŸ›£ï¸ VÃ­as y Calles</option>
              <option value="alumbrado">ğŸ’¡ Alumbrado PÃºblico</option>
              <option value="agua">ğŸ’§ Agua y Saneamiento</option>
              <option value="parques">ğŸŒ³ Parques y Jardines</option>
              <option value="seguridad">ğŸš¨ Seguridad</option>
              <option value="otros">ğŸ“‹ Otros</option>
            </select>
          </div>

          <!-- UbicaciÃ³n -->
          <div class="form-group">
            <label for="ubicacion" class="form-label">ğŸ“ UbicaciÃ³n</label>
            <input 
              type="text" 
              id="ubicacion" 
              class="form-input"
              [(ngModel)]="newQueja.ubicacion"
              name="ubicacion"
              placeholder="Ej: Av. Principal 123, San Isidro"
            />
          </div>

          <!-- Upload de imagen -->
          <div class="form-group">
            <label class="form-label">ğŸ–¼ï¸ Foto del problema (opcional)</label>
            <div class="upload-area" (click)="fileInput.click()">
              <input 
                #fileInput
                type="file" 
                accept="image/*" 
                (change)="onFileSelected($event)"
                style="display: none;"
              />
              <div *ngIf="!newQueja.imagenPreview" class="upload-placeholder">
                <span class="upload-icon">ğŸ“·</span>
                <span class="upload-text">Click para subir una foto</span>
              </div>
              <div *ngIf="newQueja.imagenPreview" class="image-preview">
                <img [src]="newQueja.imagenPreview" alt="Preview" />
                <button 
                  type="button" 
                  class="remove-image" 
                  (click)="removeImage($event)"
                >
                  âœ•
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- Footer del modal -->
      <div class="modal-footer">
        <button 
          type="button" 
          class="btn btn-cancel" 
          (click)="closeCreateModal()"
        >
          Cancelar
        </button>
        <button 
          type="button" 
          class="btn btn-primary" 
          (click)="submitQueja()"
          [disabled]="!isFormValid()"
        >
          Publicar Reporte
        </button>
      </div>
    </div>
  </div>

  <!-- Posts -->
  <ng-container *ngIf="posts.length > 0; else emptyState">
    <div *ngFor="let post of posts; trackBy: trackByPostId" class="post-card">
      <!-- Header -->
      <div class="post-header">
        <div class="avatar-container">
          <img [src]="getAvatarUrl(post)" [alt]="getAuthorName(post)" class="avatar" />
        </div>

        <div class="post-info">
          <div class="post-title-row">
            <div>
              <div class="post-author">{{ getAuthorName(post) }}</div>
              <div class="post-meta">
                <span class="post-date">{{ getPostDate(post) }}</span>
                <ng-container *ngIf="hasLocation(post)">
                  <span class="dot-sep">â€¢</span>
                  <span class="post-location">ğŸ“ {{ getLocation(post) }}</span>
                </ng-container>
              </div>
            </div>

            <button class="post-menu" aria-label="MÃ¡s opciones">â‹¯</button>
          </div>

          <h3 class="post-heading">{{ getTitle(post) }}</h3>
          <p class="post-text">{{ getDescription(post) }}</p>

          <div class="post-tags">
            <span class="tag category-tag">{{ getCategoryName(post) }}</span>
            <span *ngIf="post.estado?.nombre" class="tag status-tag">{{ post.estado?.nombre }}</span>
          </div>

          <div *ngIf="hasLocation(post)" class="post-location-line">
            <span class="location-icon">ğŸ“</span>
            <span class="location-text">{{ getLocation(post) }}</span>
          </div>
        </div>
      </div>

      <!-- Image / evidence carousel: show first evidence image -->
      <div class="post-image-wrapper">
        <ng-container *ngIf="hasEvidence(post); else imagePlaceholder">
          <img [src]="getFirstEvidenceUrl(post)" [alt]="getTitle(post)" class="post-image" />
        </ng-container>

        <ng-template #imagePlaceholder>
          <div class="image-placeholder">
            <div class="image-placeholder-icon">ğŸ–¼ï¸</div>
          </div>
        </ng-template>
      </div>

      <!-- Vote section -->
      <div *ngIf="hasVotes(post)" class="vote-section">
        <div class="vote-question">
          Â¿EstÃ¡s de acuerdo con este reporte?
          <span class="vote-count">{{ getTotalVotes(post) }} votos</span>
        </div>

        <div class="vote-buttons">
          <button
            class="vote-btn accept"
            [class.voted]="post.userVote === 'YES'"
            [disabled]="!canVote(post)"
            (click)="vote(post, 'accept')"
          >
            âœ… SÃ­ ({{ getYesVotes(post) }})
          </button>

          <button
            class="vote-btn reject"
            [class.voted]="post.userVote === 'NO'"
            [disabled]="!canVote(post)"
            (click)="vote(post, 'reject')"
          >
            âŒ No ({{ getNoVotes(post) }})
          </button>
        </div>
      </div>

      <!-- Actions row (reactions & comments) -->
      <div class="post-actions">
        <div class="left-actions">
          <button class="action-btn" (click)="toggleReaction(post, 'like')">
            <span class="action-emoji">{{ getLikeEmoji(post) }}</span>
            <span class="action-text">{{ getReactionCount(post, 'like') }}</span>
          </button>

          <button class="action-btn" (click)="toggleComments(post)">
            <span class="action-emoji">ğŸ’¬</span>
            <span class="action-text">{{ post.commentsCount || (post.comments?.length || 0) }}</span>
          </button>
        </div>

        <div class="right-actions">
          <button class="action-btn" (click)="toggleBookmark(post)">
            <span class="action-emoji">{{ getBookmarkEmoji(post) }}</span>
            <span class="action-text">Guardar</span>
          </button>

          <button class="action-btn" (click)="sharePost(post)">
            <span class="action-emoji">ğŸ“¤</span>
            <span class="action-text">Compartir</span>
          </button>

          <button class="action-btn" (click)="downloadPostJson(post)">
            <span class="action-emoji">â¬‡ï¸</span>
            <span class="action-text">JSON</span>
          </button>
        </div>
      </div>

      <!-- Comments -->
      <div *ngIf="getShowComments(post)" class="comments-section">
        <div *ngFor="let comment of post.comments || []; trackBy: trackByComment" class="comment">
          <strong>{{ getCommentAuthor(comment) }}:</strong>
          {{ getCommentText(comment) }}
        </div>

        <div class="comment-input-container">
          <input
            #commentInput
            type="text"
            class="comment-input"
            placeholder="Escribe un comentario..."
            (keyup.enter)="addComment(post, commentInput.value); commentInput.value = ''"
          />
        </div>
      </div>
    </div>
  </ng-container>

  <!-- Empty state -->
  <ng-template #emptyState>
    <div class="no-posts">
      <div class="no-posts-inner">
        <div class="no-posts-icon">ğŸ”</div>
        <h3>No se encontraron reportes</h3>
        <p>Intenta cambiar los filtros o tÃ©rminos de bÃºsqueda</p>
      </div>
    </div>
  </ng-template>
</div>