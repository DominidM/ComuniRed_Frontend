<div class="container">
  <div class="editar-perfil-container">

    <div class="header" *ngIf="!cargando && !error">
      <button class="btn-volver" (click)="volver()">
        ‚Üê Volver
      </button>
    </div>

    <h2>Editar Perfil</h2>

    <div *ngIf="cargando" class="loading">
      <div class="spinner"></div>
      <p>Cargando perfil...</p>
    </div>

    <div *ngIf="error && !cargando" class="error-message">
      <p>{{ error }}</p>
      <button class="btn-secondary" (click)="volver()">Volver</button>
    </div>

    <div *ngIf="!cargando && !error && usuario" class="perfil-form">

      <div class="avatar-section">
        <div class="avatar-container">
          <img 
            [src]="avatarPreview || 'assets/default-avatar.png'" 
            alt="Avatar" 
            class="avatar"
          />
          <div class="avatar-overlay">
            <label for="file-input" class="avatar-label">
              üì∑
            </label>
            <input 
              id="file-input" 
              type="file" 
              accept="image/*" 
              (change)="cambiarAvatar($event)"
              style="display: none;"
            />
          </div>
        </div>
        <p class="avatar-info">Tama√±o m√°ximo: 5MB</p>
      </div>

      <!-- Formulario de datos personales -->
      <form>
        <!-- Nombre -->
        <div class="form-group">
          <label for="nombre">Nombre *</label>
          <input
            id="nombre"
            type="text"
            [(ngModel)]="usuario.nombre"
            name="nombre"
            placeholder="Ingresa tu nombre"
            required
          />
        </div>

        <div class="form-group">
          <label for="apellido">Apellido *</label>
          <input
            id="apellido"
            type="text"
            [(ngModel)]="usuario.apellido"
            name="apellido"
            placeholder="Ingresa tu apellido"
            required
          />
        </div>

        <div class="form-group">
          <label for="dni">DNI *</label>
          <input
            id="dni"
            type="text"
            [(ngModel)]="usuario.dni"
            name="dni"
            placeholder="12345678"
            maxlength="8"
            pattern="[0-9]{8}"
            required
          />
        </div>

        <div class="form-group">
          <label for="email">Email *</label>
          <input
            id="email"
            type="email"
            [(ngModel)]="usuario.email"
            name="email"
            placeholder="tu@email.com"
            required
          />
        </div>

        <div class="form-group">
          <label for="numero_telefono">Tel√©fono</label>
          <input
            id="numero_telefono"
            type="tel"
            [(ngModel)]="usuario.numero_telefono"
            name="numero_telefono"
            placeholder="987654321"
          />
        </div>

        <!-- ‚úÖ NUEVA SECCI√ìN: Fecha de nacimiento y edad calculada -->
        <div class="form-group">
          <label for="fecha_nacimiento">Fecha de Nacimiento</label>
          <input
            id="fecha_nacimiento"
            type="date"
            [(ngModel)]="usuario.fecha_nacimiento"
            name="fecha_nacimiento"
            [max]="hoy"
          />
          <small style="color: #6b7280; font-size: 0.875rem;">La edad se calcula autom√°ticamente</small>
        </div>

        <!-- ‚úÖ EDAD CALCULADA (solo lectura) -->
        <div class="form-group" *ngIf="usuario.fecha_nacimiento">
          <label>Edad</label>
          <input
            type="text"
            [value]="calcularEdad(usuario.fecha_nacimiento) + ' a√±os'"
            readonly
            style="background-color: #f3f4f6; cursor: not-allowed;"
          />
          <small style="color: #6b7280; font-size: 0.875rem;">Calculada desde la fecha de nacimiento</small>
        </div>

        <div class="form-group">
          <label for="sexo">Sexo</label>
          <select
            id="sexo"
            [(ngModel)]="usuario.sexo"
            name="sexo"
          >
            <option value="">Seleccionar</option>
            <option value="M">Masculino</option>
            <option value="F">Femenino</option>
            <option value="Otro">Otro</option>
          </select>
        </div>

        <div class="form-group">
          <label for="distrito">Distrito</label>
          <input
            id="distrito"
            type="text"
            [(ngModel)]="usuario.distrito"
            name="distrito"
            placeholder="San Isidro"
          />
        </div>

        <div class="form-group">
          <label for="codigo_postal">C√≥digo Postal</label>
          <input
            id="codigo_postal"
            type="text"
            [(ngModel)]="usuario.codigo_postal"
            name="codigo_postal"
            placeholder="15073"
          />
        </div>

        <div class="form-group" style="grid-column: 1 / -1;">
          <label for="direccion">Direcci√≥n</label>
          <textarea
            id="direccion"
            [(ngModel)]="usuario.direccion"
            name="direccion"
            rows="3"
            placeholder="Av. Principal 123"
          ></textarea>
        </div>

        <!-- ‚úÖ Mostrar fecha de registro (solo lectura) -->
        <div class="form-group" style="grid-column: 1 / -1;" *ngIf="usuario.fecha_registro">
          <label for="fecha_registro">Fecha de Registro</label>
          <input
            id="fecha_registro"
            type="text"
            [value]="usuario.fecha_registro | date:'dd/MM/yyyy HH:mm'"
            readonly
            style="background-color: #f3f4f6; cursor: not-allowed;"
          />
          <small style="color: #6b7280; font-size: 0.875rem;">Este campo no se puede modificar</small>
        </div>

        <div class="acciones">
          <button
            type="button"
            class="btn-cancelar"
            (click)="cancelar()"
            [disabled]="guardando"
          >
            Cancelar
          </button>
          
          <button
            type="button"
            class="btn-guardar"
            (click)="guardarCambios()"
            [disabled]="!hayCambios() || guardando"
          >
            <span *ngIf="!guardando">Guardar Cambios</span>
            <span *ngIf="guardando">
              <span class="spinner-small"></span> Guardando...
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
